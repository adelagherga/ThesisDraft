%% The following is a directive for TeXShop to indicate the main file
%%!TEX root = diss.tex

\chapter{Algorithms for Thue-Mahler Equations}
\label{ch:AlgorithmsForTM}

\begin{enumerate}
\item First Steps \autoref{sec:FirstSteps}
\item rel number field \autoref{sec:RelevantAlgNumField}
\item Lattices \autoref{sec:Lattices}
\item Setup with Lemmata from Samir
\item LLL [DONE - roughly]
\item Fincke-Pohst with changes from Benjamin [DONE- roughly]
\item linear forms in logs
\end{enumerate}

%--------------------------------------------------------------------------------------------------------------------------------------------%
%--------------------------------------------------------------------------------------------------------------------------------------------%

\section{First steps}
\label{sec:FirstSteps}

Fix a nonzero integer $c$ and let $S=\{p_1,\dotsc,p_v\}$ be a set of rational primes. Let
\[F(X,Y) = c_0 X^n + c_1 X^{n-1}Y + \cdots + c_{n-1}XY^{n-1} + c_nY^n\]
be an irreducible binary form over $\mathbb{Z}$ of degree $n \geq 3$. We want to solve the Thue--Mahler equation
\begin{equation} \label{eq:ThueMahler}
F(X,Y) = c p_1^{Z_1}\cdots p_v^{Z_v}
\end{equation}
for unknowns $X,Y, Z_1, \dots, Z_v$ with $\gcd(X,Y) = 1$ and $Z_i \geq 0$ for $i = 1,\dots, v$. To do so, we first reduce \eqref{eq:ThueMahler} to the special case where $c_0 = 1$ and $\gcd(c,p_i) = 1$ for $i = 1, \dots, v$. 

As $F$ is irreducible by assumption, at least one of the coefficients $c_0$ and $c_n$ is nonzero. Hence, we may transform the given Thue--Mahler equation to one with $c_0 \neq 0$ by interchanging $X$ and $Y$ and by renaming the coefficients $c_i$ appropriately. In particular, solving \eqref{eq:ThueMahler} is equivalent to solving 
\[ c_0' \overline{X}^n + c_1' \overline{X}^{n-1}\overline{Y} + \cdots + c_{n-1}'\overline{X}\overline{Y}^{n-1} + c_n'\overline{Y}^n = c p_1^{Z_1}\cdots p_v^{Z_v},\]
where $c_i' = c_{n-1}$ for $i = 0, \dots, n$, $\overline{X} = Y$, and $\overline{Y} = X$. 

Denote by $\mathcal{D}$ the set of all positive rational integers $m$ dividing $c_0$ such that ${\ord_p(m)\leq \ord_p(c)}$ for each rational prime $p\notin S$. Equivalently, $\mathcal{D}$ is precisely the set of all possible integers $d$ such that $d = \gcd(c_0,Y)$. To see this, let $q_1, \dots, q_{w}$ denote the distinct prime divisors of $a$ not contained in $S$. Then 
\[c = \prod_{i=1}^w q_i^{b_i}\cdot \prod_{i=1}^v p_i^{\ord_{p_i}(c)}\]
for some integers $b_i >0$. If $(X,Y,Z_1, \dots, Z_v)$ is a solution of the Thue-Mahler equation in question, it follows that
\[F(X,Y) = cp_1^{Z_1}\dots p_v^{Z_v} =  \prod_{i=1}^w q_i^{b_i}\cdot \prod_{i=1}^v p_i^{\ord_{p_i}(c) + Z_i}.\]
Suppose $\gcd(c_0,Y) = d$. Since $d$ divides $F(X,Y)$, it necessarily divides 
\[{\prod_{i=1}^w q_i^{b_i}\cdot \prod_{i=1}^v p_i^{\ord_{p_i}(c) + Z_i}}.\] 
In particular, 
\[d = \prod_{i=1}^w q_i^{s_i}\cdot \prod_{i=1}^v p_i^{t_i}\]
for some non-negative integers $s_1, \dots, s_w, t_1, \dots, t_v$ such that 
\[s_i \leq \min\{\ord_{q_i}(c), \ord_{q_i}(c_0)\} \quad \text{ and } \quad 
	t_i \leq \min\{\ord_{p_i}(c) + Z_i, \ord_{p_i}(c_0)\}.\] 
From here, it is easy to see that ${\ord_p(d)\leq \ord_p(c)}$ for each rational prime $p\notin S$ so that $d \in \mathcal{D}$. 

Conversely, suppose $d \in \mathcal{D}$ so that $\ord_{p}(d) \leq \ord_{p}(c)$ for all $p \notin S$. That is, the right-hand side of 
\[\ord_{p}(d) \leq \ord_{p}(c) = 
\ord_p\left(\prod_{i=1}^w q_i^{b_i}\cdot \prod_{i=1}^v p_i^{\ord_{p_i}(c)}\right)\]
is non-trivial only at the primes $\{q_1, \dots, q_w\}$. In particular, 
\[d = \prod_{i=1}^w q_i^{s_i}\cdot \prod_{i=1}^v p_i^{t_i}\]
for non-negative integers $s_1, \dots, s_w, t_1, \dots, t_v$ such that 
\[s_i \leq \min\{\ord_{q_i}(c), \ord_{q_i}(c_0)\} \quad \text{ and } \quad 
	t_i \leq \ord_{p_i}(c_0).\] 
It follows that $d = \gcd(c_0,Y)$ for some solution $(X,Y,Z_1, \dots, Z_v)$ of equation~\eqref{eq:ThueMahler}. 

For any $d\in \mathcal{D}$, we define the rational numbers 
\[u_d = c_0^{n-1}/d^n \quad \textnormal{and}\quad c_d = \sgn(u_dc)\prod_{p\notin S} p^{\ord_p(u_dc)}.\]
On using that $d\in \mathcal{D}$, we see that the rational number $c_d$ is in fact an integer coprime to $S$. 

Suppose $(X,Y,Z_1, \dots, Z_v)$ is a solution of \eqref{eq:ThueMahler} with ${\gcd(X,Y) = 1}$ and $d = \gcd(c_0,Y)$. Define the homogeneous polynomial $f(x,y) \in \mathbb{Z}[x,y]$ of degree $n$ by
\[f(x,y) = x^n + C_1 x^{n-1}y + \dots + C_{n-1}xy^{n-1} + C_ny^n,\]
where
\[x=\tfrac{c_0X}{d},\quad y=\tfrac{Y}{d} \quad \text{ and } \quad C_i = c_ic_0^{i-1} \quad \text{ for } i = 1, \dots, n.\]
Since $\gcd(X,Y) = 1$, the numbers $x$ and $y$ are also coprime integers by definition of $d$. We observe that 
\[f(x,y) = u_dF(X,Y) = u_dc \prod_{i = 1}^v p_i^{Z_i} = c_d\prod_{p \in S}p^{Z_i + \ord_p(u_dc)}.\]
Setting $z_i = Z_i + \ord_p(u_dc)$ for all $i \in \{1, \dots, v\}$, we obtain
\begin{equation} \label{eq:ThueMahler2}
f(x,y) = x^n + C_1 x^{n-1}y + \dots + C_{n-1}xy^{n-1} + C_ny^n = c_d p_1^{z_1}\cdots p_v^{z_v}, 
\end{equation}
where $\gcd(x,y) = 1$ and $\gcd(c_d,p_i) = 1$ for all $i = 1, \dots, v$. 

Since there are only finitely many choices for $d = \gcd(c_0, Y)$, there are only finitely many choices for $\{c_d,u_d,d\}$. Then, solving \eqref{eq:ThueMahler} is equivalent to solving the finitely many Thue-Mahler equations \eqref{eq:ThueMahler2} for each choice of $\{c_d,u_d,d\}$.  For each such choice, the solution $\{x,y,z_1, \dots, z_v\}$ is related to $\{X,Y, Z_1, \dots, Z_v\}$ via
\[X = \frac{dx}{c_0},\quad Y=dy \quad \text{ and } \quad Z_i = z_i - \ord_p(u_dc).\]

Lastly, we observe that the polynomial $f(x,y)$ of \eqref{eq:ThueMahler2} remains the same for any choice of $\{c_d,u_d,d\}$. Thus, to solve the family of equations \eqref{eq:ThueMahler2}, we need only to enumerate over every possible $c_d$. Now, if $\mathcal{C}$ denotes the set of all $\{c_d,u_d,d\}$ and $d_1, d_2 \in \mathcal{D}$, we may have $\{c_{d_1},u_{d_1}, d_1\}, \{c_{d_2},u_{d_2}, d_2\} \in \mathcal{C}$ where $c_{d_1} = c_{d_2}$. That is, $d_1, d_2$ may yield the same value of $c_d$, reiterating that we need only solve \eqref{eq:ThueMahler2} for each distinct $c_d$. 

%--------------------------------------------------------------------------------------------------------------------------------------------%
%--------------------------------------------------------------------------------------------------------------------------------------------%

\section{The relevant algebraic number field}
\label{sec:RelevantAlgNumField}

For the remainder of this chapter, we consider the Thue-Mahler equation
\begin{equation} \label{eq:ThueMahler3}
f(x,y) = x^n + C_1 x^{n-1}y + \dots + C_{n-1}xy^{n-1} + C_ny^n = c p_1^{z_1} \cdots p_v^{z_v}
\end{equation}
where $\gcd(x,y) = 1$ and $\gcd(c,p_i) = 1$ for $i = 1, \dots, p_v$.

Following \edit{Tzanakis, de Weger, Hambrook}, put
\[g(t) = f(t,1) = t^n + C_1 t^{n-1} + \dots + C_{n-1}t + C_n\]
and note that $g(t)$ is irreducible in $\mathbb{Z}[t]$. Let $K = \mathbb{Q}(\theta)$ with $g(\theta) = 0$. Now \eqref{eq:ThueMahler3} is equivalent to the norm equation
\begin{equation} \label{eq:normTM}
N_{K/\mathbb{Q}}(x-y\theta) = cp_1^{z_1}\dots p_v^{z_v}.
\end{equation}

Let $p_i$ be any rational prime and let 
\[(p_i)\mathcal{O}_K = \prod_{j = 1}^{m_i} \mathfrak{p}_{ij}^{e(\mathfrak{p}_{ij}|p_i)}\]
be the factorization of $p_i$ into prime ideals in the ring of integers $\mathcal{O}_K$ of $K$. Let $f(\mathfrak{p}_{ij}|p_i)$ be the inertial degree of $\mathfrak{p}_{ij}$ over $p_i$. Since $N(\mathfrak{p}_{ij}) = p_i^{f_{ij}}$, \eqref{eq:normTM} leads to finitely many ideal equations of the form
\begin{equation} \label{eq:idealTM}
(x-y\theta)\mathcal{O}_K = \mathfrak{a} \prod_{j = 1}^{m_1} \mathfrak{p}_{1j}^{z_{1j}} \cdots \prod_{j = 1}^{m_v} \mathfrak{p}_{vj}^{z_{vj}}
\end{equation}
where $\mathfrak{a}$ is an ideal of norm $|c|$ and the $z_{ij}$ are unknown integers related to $z_i$ by 
\[\sum_{j = 1}^{m_i} f(\mathfrak{p}_{ij}|p_i)z_{ij} = z_i\]
for $i \in \{1, \dots, v\}$.

Our first task is to cut down the number of variables appearing in \eqref{eq:idealTM}. We will do this by showing that only a few prime ideals can divide $(x-y\theta)\mathcal{O}_K$ to a large power. 

%--------------------------------------------------------------------------------------------------------------------------------------------%
%--------------------------------------------------------------------------------------------------------------------------------------------%

\section{The prime ideal removing lemma}
\label{sec:PIRL}

In this section, we establish some key results that will allow us to cut down the number of prime ideals that can appear to a large power in the factorization of $(x-y\theta)\mathcal{O}_K$. It is of particular importance to note that we do not appeal to the Prime Ideal Removing Lemma of Tzanakis, de Weger \edit{ref and Hambrook} here and instead apply the following results of \edit{cite new paper}

Let $p \in \{p_1, \dots, p_v\}$. We will produce the following two finite lists $L_p$ and $M_p$. The list $L_p$ will
consist of certain ideals $\mathfrak{b}$ of $\mathcal{O}_K$ supported at the prime ideals above $p$. The list $M_p$ will consist of certain pairs $(\mathfrak{b},\mathfrak{p})$ where $\mathfrak{b}$ is supported at the prime ideals above $p$ and $\mathfrak{p}$ is a prime ideal lying over $p$ satisfying $e(\mathfrak{p}|p)=f(\mathfrak{p}|p)=1$. These lists will satisfy the following property: if $(x,y,z_1,\dots,z_v)$ is a solution to the Thue-Mahler equation \eqref{eq:ThueMahler3} then
\begin{enumerate}[(i)]
\item either there is some $\mathfrak{b} \in L_p$
such that
\begin{equation} \label{eq:Lp}
\mathfrak{b} \mid (x-y\theta )\mathcal{O}_K, \qquad \text{$(x-y\theta)\mathcal{O}_K/\mathfrak{b}$ is coprime to $(p)\mathcal{O}_K$};
\end{equation}
\item or there is a pair $(\mathfrak{b},\mathfrak{p}) \in M_p$ and a non-negative integer $v_p$ such that
\begin{equation} \label{eq:Mp}
(\mathfrak{b} \mathfrak{p}^{v_p}) \mid (x-y\theta)\mathcal{O}_K, \qquad \text{$(x-y\theta)\mathcal{O}_K/(\mathfrak{b} \mathfrak{p}^{v_p})$ is coprime to $(p)\mathcal{O}_K$}.
\end{equation}
\end{enumerate}

To generate the lists $M_p$, $L_p$ we consider two affine patches, $p \nmid y$ and $p \mid y$. We begin with the following lemmata.

\begin{lemma} \label{lem:AffinePatch1}\edit{[Siksek]}
Let $(x,y,z_1, \dots, z_v)$ be a solution of \eqref{eq:ThueMahler3} with $p \nmid y$, let $t$ be a positive integer, and suppose $x/y \equiv u \pmod{p^t}$, where ${u \in \{0,1,2,\dotsc,p^{t}-1\}}$. If $\mathfrak{q}$ is a prime ideal of $\mathcal{O}_K$ lying over $p$, then
\[\ord_{\mathfrak{q}}(x-y\theta)\ge \min\{\ord_{\mathfrak{q}}(u-\theta), t \cdot e(\mathfrak{q}|p)\}.\]
Moreover, if $\ord_{\mathfrak{q}}(u-\theta) < t \cdot e(\mathfrak{q}|p)$, then
\[\ord_\mathfrak{q}(x-y\theta) = \ord_{\mathfrak{q}}(u-\theta).\]
\end{lemma}

\begin{lemma} \label{lem:AffinePatch2} \edit{[Siksek]}
Let $(x,y,z_1, \dots, z_v)$ be a solution of \eqref{eq:ThueMahler3} with $p \mid y$ (and thus $p \nmid x$), let $t$ be a positive integer, and suppose $y/x \equiv u \pmod{p^t}$, where $u \in \{0,1,2,\dotsc,p^{t}-1\}$. If $\mathfrak{q}$ is a prime ideal of $\mathcal{O}_K$ lying over $p$, then
\[\ord_{\mathfrak{q}}(x-y\theta)\ge \min\{\ord_{\mathfrak{q}}(1-\theta u), t \cdot e(\mathfrak{q}|p)\}.\]
Moreover, if $\ord_{\mathfrak{q}}(1-\theta u) < t \cdot e(\mathfrak{q}|p)$, then
\[\ord_\mathfrak{q}(x-y\theta) = \ord_{\mathfrak{q}}(1 - \theta u).\]
\end{lemma}

\begin{proof}[Proof of Lemmas~\ref{lem:AffinePatch1} and \ref{lem:AffinePatch2}]
Suppose $p \nmid y$. Thus $\ord_{\mathfrak{q}}(y) = 0$ and hence 
\[\ord_{\mathfrak{q}}(x-y\theta) = \ord_{\mathfrak{q}}(x/y - \theta).\]
Since $x/y-\theta = u - \theta + x/y - u,$ we have
\[\begin{array}{ll}
\ord_\mathfrak{q}(x/y-\theta)	& = \ord_{\mathfrak{q}}(u - \theta + x/y - u) \\
						& \geq \min\{\ord_{\mathfrak{q}}(u - \theta), \ord_{\mathfrak{q}}(x/y - u)\}. 
\end{array}\]
By assumption, 
\[\ord_{\mathfrak{q}}(x/y-u) \geq \ord_{\mathfrak{q}}(p^t) = t \cdot e(\mathfrak{q}|p),\]
 %Thus $\ord_\fq(x-\theta)=\ord_\fq(u-\theta)$,
completing the proof of Lemma~\ref{lem:AffinePatch1}. The proof of Lemma~\ref{lem:AffinePatch2} is similar. 
\end{proof}

The following algorithm computes the lists $L_p$ and $M_p$ that come from the first patch $p \nmid y$. We denote these respectively by $\mathcal{L}_p$ and $\mathcal{M}_p$. 

\begin{algorithm} \label{alg:AffinePatch1}
To compute
$\mathcal{L}_p$ and $\mathcal{M}_p$:

\begin{enumerate}[Step (1)]
\item Let 
\[\mathcal{L}_p \leftarrow \emptyset, \qquad \mathcal{M}_p \leftarrow \emptyset,\]
\[ t \leftarrow 1, \quad \mathcal{U} \leftarrow \{w : w \in \{0,1,\dots,p-1\} \}.\]
\item Let
\[\mathcal{U}^\prime \leftarrow \emptyset.\]
Loop through the elements $u \in \mathcal{U}$. Let 
\[\mathcal{P}_u= \{\mathfrak{q} \text{ lying above } p \ : \ \ord_{\mathfrak{q}}(u-\theta) \geq t \cdot e(\mathfrak{q}|p)\}\]
and
\[ \mathfrak{b}_u 	= \prod_{\mathfrak{q} \mid p} \mathfrak{q}^{\min\{\ord_\mathfrak{q}(u-\theta), t \cdot e(\mathfrak{q}|p)\}} 
				= (u-\theta) \mathcal{O}_K+p^t \mathcal{O}_K.\]
\begin{enumerate}[(i)]
\item If $\mathcal{P}_u = \emptyset$ then
\[\mathcal{L}_p \leftarrow \mathcal{L}_p \cup \{\mathfrak{b}_u\}.\]
\item Else if $\mathcal{P}_u = \{\mathfrak{p}\}$ with $e(\mathfrak{p}|p)=f(\mathfrak{p}|p)=1$ and there is at least one $\mathbb{Z}_p$-root $\alpha$ of $g(t)$ satisfying $\alpha \equiv u \pmod{p^t}$, then
\[\mathcal{M}_p \leftarrow \mathcal{M}_p \cup \{ (\mathfrak{b}_u,\mathfrak{p})\}.\]
\item Else 
\[\mathcal{U}^\prime \leftarrow \mathcal{U} \cup \{ u+p^{t}w : w \in \{0,\dots,p-1\} \}.\]
\end{enumerate}

\item If $\mathcal{U}^\prime \ne \emptyset$ then let
\[t \leftarrow t+1, \qquad \mathcal{U} \leftarrow \mathcal{U}^{\prime},\]
and return to Step (2). Else output $\mathcal{L}_p$, $\mathcal{M}_p$.
\end{enumerate}
\end{algorithm}

\begin{lemma}
Algorithm~\ref{alg:AffinePatch1} terminates.
\end{lemma}

\begin{proof}
Suppose otherwise. Write $t_0=1$ and $t_i=t_0+i$ for $i=1,2,3,\dots$. Then there is an infinite sequence of congruence classes $u_i \mod{p^{t_i}}$ such that ${u_{i+1} \equiv u_i \mod{p^{t_i}}}$, and such that the $u_i$ fail the hypotheses of both (i) and (ii). This means that $\mathcal{P}_{u_i}$ is non-empty for every $i \in \mathbb{N}_{>0}$. By the pigeon-hole principle, some prime ideal $\mathfrak{p}$ of $\mathcal{O}_K$ appears in infinitely many of the $\mathcal{P}_{u_i}$. Thus ${\ord_{\mathfrak{p}}(u_i-\theta) \ge t_i\cdot e(\mathfrak{p}|p)}$ infinitely often. However, the sequence $\{u_i\}_{i=1}^{\infty}$ converges to some $\alpha \in \mathbb{Z}_p$ so that $\alpha=\theta$ in $K_\mathfrak{p}$. This forces $e(\mathfrak{p}|p)=f(\mathfrak{p}|p)=1$ and $\alpha$ to be a $\mathbb{Z}_p$-root of $g(t)$. In this case, $\mathfrak{p}$ corresponds to the factor $(t-\alpha)$ in the $p$-adic factorisation of $g(t)$. There can be at most one such $\mathfrak{p}$, forcing $\mathcal{P}_{u_i}=\{\mathfrak{p}\}$ for all $i$. In particular, the hypothesis of (ii) are satisfied and we reach a contradiction.
\end{proof}

\begin{lemma}\label{lem:AffinePatch1Check}
Let $p \in \{p_1, \dots, p_v\}$ and let $\mathcal{L}_p$, $\mathcal{M}_p$ be as given by Algorithm~\ref{alg:AffinePatch1}. Let $(x,y,z_1,\dots, z_v)$ be a solution to \eqref{eq:ThueMahler3}. Then
\begin{itemize}
\item either there is some $\mathfrak{b} \in \mathcal{L}_p$ such that \eqref{eq:Lp} is satisfied; 
\item or there is some $(\mathfrak{b},\mathfrak{p}) \in \mathcal{M}_p$ with $e(\mathfrak{p}|p)=f(\mathfrak{p}|p)=1$ and integer $v_p \geq 0$ such that \eqref{eq:Mp} is satisfied.
\end{itemize}
\end{lemma}

\begin{proof}
Let 
\[t_0 = 1 \quad \text{ and } \quad \mathcal{U}_0=\{w \; :\;  w \in \{0,1,\dots,p-1\}\}\]
be the initial values for $t$ and $\mathcal{U}$ in the algorithm. Then $x/y \equiv u_0 \pmod{p^{t_0}}$ for some $u_0 \in \mathcal{U}_0$. Write $\mathcal{U}_i$ for the value of $\mathcal{U}$ after $i$ iterations of the algorithm  and let $t_i=t_0+i$. As the algorithm terminates, $\mathcal{U}_i = \emptyset$ for some sufficiently large $i$. Hence there is some $i$ such that $x/y \equiv u_i \mod{p^{t_i}}$ where $u_i \in \mathcal{U}_i$, but there is no element in $\mathcal{U}_{i+1}$ congruent to $x/y$ modulo $p^{t_{i+1}}$. In other words, $u_i$ must satisfy the hypotheses of either step (i) or (ii) of algorithm~\ref{alg:AffinePatch1}. Write $u=u_i$ and $t=t_i$ for $x/y \equiv u \mod{p^t}$ and consider the ideal $\mathfrak{b}_u$ generated in this step. By Lemma~\ref{lem:AffinePatch1}, $\mathfrak{b}_u$ divides $(x-y\theta) \mathcal{O}_K$. Furthermore, by definition of $\mathcal{P}_u$, if $\mathfrak{q}$ is a prime ideal of $\mathcal{O}_K$ not contained in $\mathcal{P}_u$, then $(x-y\theta)\mathcal{O}_K/\mathfrak{b}_u$ is not divisible by $\mathfrak{q}$. 

Suppose first that the hypothesis of (i) is satisfied: $\mathcal{P}_u = \emptyset$. The algorithm adds $\mathfrak{b}_u$ to the set $\mathcal{L}_p$, with the above remarks ensuring that \eqref{eq:Lp} is satisfied.

Suppose next that the hypothesis of (ii) is satisfied: $\mathcal{P}_u=\{\mathfrak{p}\}$ where ${e(\mathfrak{p}|p)=f(\mathfrak{p}|p)=1}$ and there is a unique $\mathbb{Z}_p$ root $\alpha$ of $g(t)$ such that $\alpha \equiv u \mod{p^t}$. The algorithm adds $(\mathfrak{b}_u,\mathfrak{p})$ to the set $\mathcal{M}_p$. By the above, $(x-y\theta)\mathcal{O}_K/\mathfrak{b}_u$ is an integral ideal, not divisible by any prime ideal $\mathfrak{q} \neq \mathfrak{p}$ lying over $p$. Thus there is some positive integer $v_p \geq 0$ such that \eqref{eq:Mp} is satisfied, concluding the proof. 
\end{proof}

Having computed the lists arising from the affine patch $p \nmid y$, we initialize $L_p$ and $M_p$ as $\mathcal{L}_p$ and $\mathcal{M}_p$, respectively, and append to these lists the elements from the second patch, $p \mid y$, using the following algorithm.  

\begin{algorithm}\label{alg:AffinePatch2}
To compute $L_p$ and $M_p$.

\begin{enumerate}[Step (1)]
\item Let 
\[ L_p \leftarrow \mathcal{L}_p, \qquad M_p \leftarrow \mathcal{M}_p,\]
where $\mathcal{L}_p$, $\mathcal{M}_p$ are computed by Algorithm~\ref{alg:AffinePatch1}.
\item Let
\[ t \leftarrow 2, \qquad \mathcal{U} \leftarrow \{pw \; : \; w \in \{0,1,\dots,p-1\} \}.\]
\item Let
\[ \mathcal{U}^{\prime} \leftarrow \emptyset.\]
Loop through the elements $u \in \mathcal{U}$. Let 
\[\mathcal{P}_u=\{\mathfrak{q} \text{ lying above } p \ : \ \ord_{\mathfrak{q}}(1-u\theta ) \ge t \cdot e(\mathfrak{q}|p)\},\]
and
\[ \mathfrak{b}_u=\prod_{\mathfrak{q} \mid p} \mathfrak{q}^{\min\{\ord_{\mathfrak{q}}(1-u\theta ), t \cdot e(\mathfrak{q}|p)\}} =(1-u\theta) \mathcal{O}_K+p^t \mathcal{O}_K.\]

\begin{enumerate}[(i)]
\item If $\mathcal{P}_u=\emptyset$  
%$\ord_p(\Norm(u-\theta)) \ge (n-1) c_0$ 
then
\[L_p \leftarrow L_p \cup \{\mathfrak{b}_u\}.\]
%\item[(ii)] Else if $\cP_u=\{\fp\}$ with
%$e(\fp/p)=f(\fp/p)=1$, 
%and
%$\ord_p(\Norm(u-\theta)) \ge (n-1) c_0$,
%and there is at least on $\Z_p$-root $\alpha$ of 
%$f$ satisfying $\alpha \equiv u \pmod{p^t}$,
%then
%\[
%\cM_p \leftarrow \cM_p \cup \{ (\fb_u,\fp)\}.
%\]
\item Else 
\[\mathcal{U}^\prime \leftarrow \mathcal{U}^\prime \cup \{ u+p^{t}w : w \in \{0,\dotsc,p-1\} \}.\]
\end{enumerate}

\item If $\mathcal{U}^\prime \ne \emptyset$ then let
\[t \leftarrow t+1, \qquad \mathcal{U} \leftarrow \mathcal{U}^\prime,\]
and return to Step (3). Else output $L_p$, $M_p$.
\end{enumerate}
%\noindent \textbf{Output:} $\cL_p$, $\cM_p$.
\end{algorithm}

\begin{lemma} 
Algorithm~\ref{alg:AffinePatch2} terminates. 
\end{lemma}

\begin{proof}
Suppose that the algorithm does not terminate. Let $t_0=2$ and $t_i=t_0+i$ for $i \in \mathbb{N}$. Then there is an infinite sequence of congruence classes $\{u_i\}_{i = 0}^{\infty}$ and corresponding sets $\{\mathcal{P}_{u_i}\}_{i=0}^{\infty}$ such that $u_{i+1} \equiv u_i \mod{t_i}$ and $\mathcal{P}_{u_i} \ne \emptyset$ for all $i$. Moreover, $p \mid u_0$. Let $\alpha$ be the limit of $\{u_i\}_{i=0}^{\infty}$ in $\mathbb{Z}_p$. By the pigeon-hole principle, there is some ideal $\mathfrak{q}$ in $\mathcal{O}_K$ above $p$ which appears in infinitely many sets $\mathcal{P}_{u_i}$. It follows that $\ord_{\mathfrak{q}}(1 -u_i \theta) \ge t_i \cdot e(\mathfrak{q}|p)$ and thus $1-\alpha \theta=0$ in $K_{\mathfrak{q}}$. But as $p \mid u_0$, we have $\ord_p(\alpha) \ge 1$, and so $\ord_{\mathfrak{q}}(\theta)<0$. This contradicts the fact that $\theta$ is an algebraic integer. Therefore the algorithm must terminate.
\end{proof}

\begin{lemma}\label{lem:AffinePatch2Check}
Let $p \in \{p_1, \dots, p_v\}$ and let $L_p$, $M_p$ be as given by Algorithm~\ref{alg:AffinePatch2}. Let $(x,y,z_1,\dots, z_v)$ be a solution to \eqref{eq:ThueMahler3}. Then
\begin{itemize}
\item either there is some $\mathfrak{b} \in L_p$ such that \eqref{eq:Lp} is satisfied; 
\item or there is some $(\mathfrak{b},\mathfrak{p}) \in M_p$ with $e(\mathfrak{p}|p)=f(\mathfrak{p}|p)=1$ and integer $v_p \geq 0$ such that \eqref{eq:Mp} is satisfied.
\end{itemize}
\end{lemma}

\begin{proof}
Let $(x,y,z_1,\dots, z_v)$ be a solution to \eqref{eq:ThueMahler3}. In view of Lemma~\ref{lem:AffinePatch1Check} we may suppose $p \mid y$. Then $\ord_{\mathfrak{q}}(x) = 0$ and $\ord_{\mathfrak{q}}(x-y\theta)=\ord_{\mathfrak{q}}(1 - (y/x) \theta)$ for any prime ideal $\mathfrak{q}$ lying over $p$. The remainder of the proof is analogous to the proof of Lemma~\ref{lem:AffinePatch1Check}.
\end{proof}

%--------------------------------------------------------------------------------------------------------------------------------------------%

\subsection{Computational remarks and refinements}
\label{subsec:PIRLRemarks}

In implementing Algorithms~\ref{alg:AffinePatch1} and \ref{alg:AffinePatch2}, we reduce the number of prime ideals appearing in the factorization of $(x-y\theta)\mathcal{O}_K$ to a large power. The Prime Ideal Removing Lemma, as originally stated in \edit{Tzanakis, deWeger and used in Hambrook} outlines a similar process by comparing the valuations of $(x-y\theta)\mathcal{O}_K$ at two prime ideals $\mathfrak{p}_1$ and $\mathfrak{p}_2$ above $p$. Of course if $\mathfrak{p}_1 \mid (x-y\theta)\mathcal{O}_K$, we restrict the possible values for $x$ and $y$ modulo $p$. However any choice of $x$ and $y$ modulo $p$ affects the valuations of $(x-y\theta)\mathcal{O}_K$ at all prime ideals above $p$. In the present refinement outlined by Lemma~\ref{lem:AffinePatch1} and Lemma~\ref{lem:AffinePatch2}, we instead study the valuations of $(x-y\theta)\mathcal{O}_K$ at all prime ideals above $p$ simultaneously. This presents us with considerably less ideal equations of the form \ref{eq:idealTM} to resolve. \edit{In particular, we outline some examples in the following table.}

Moreover, this variant of the Prime Ideal Removing Lemma permits the following additional refinements:
\begin{itemize}
\item Let $\mathfrak{b} \in L_p$. If there exists a pair $(\mathfrak{b}^\prime,\mathfrak{p}) \in M_p$ with $\mathfrak{b}^\prime \mid \mathfrak{b}$ and $\mathfrak{b}/\mathfrak{b}^\prime=\mathfrak{p}^w$
for some $w \ge 0$, then we may delete $\mathfrak{b}$ from $L_p$. In doing so, the conclusion to Lemma~\ref{lem:AffinePatch2Check} continues to hold.
\item Suppose $(\mathfrak{b},\mathfrak{p})$, $(\mathfrak{b}^\prime,\mathfrak{p}) \in M_p$ with $\mathfrak{b}^{\prime} \mid \mathfrak{b}$, and $\mathfrak{b}/\mathfrak{b}^{\prime}=\mathfrak{p}^w$ for some ${w \geq 0}$. Then, we may delete $(\mathfrak{b},\mathfrak{p})$ from $M_p$ without affecting the conclusion to Lemma~\ref{lem:AffinePatch2Check}. 
\item \edit{After the above two refinements, we reduced the redundancy in the sets $M_p$ and $L_p$ similar to Kyle Hambrook's redundancy removal.}
\end{itemize}

\edit{ Add test examples, restructure subsection, table format?}

%--------------------------------------------------------------------------------------------------------------------------------------------%
%--------------------------------------------------------------------------------------------------------------------------------------------%

\section{Factorization of the Thue-Mahler equation}
\label{sec:FactorizationTM}

After applying Algorithm~\ref{alg:AffinePatch1} and Algorithm~\ref{alg:AffinePatch2}, we are reduced to solving finitely many ideal equations of the form
\begin{equation}\label{eq:TMfactored}
(x-y\theta)\mathcal{O}_K=\mathfrak{a} \mathfrak{p}_1^{u_1}\cdots \mathfrak{p}_{\nu}^{u_{\nu}}
\end{equation}
in integer variables $x,y,u_1, \dots, u_{\nu}$ with $u_i \geq 0$ for $i = 1, \dots, \nu$, where ${0 \leq \nu \leq v}$. For $i \in \{\nu+1, \dots, v\}$, we have 

Here
\begin{itemize}
\item for $i \in \{1, \dots, \nu\}$, $\mathfrak{p}_i$ is a prime ideal of $\mathcal{O}_K$ arising from Algorithm~\ref{alg:AffinePatch1} and Algorithm~\ref{alg:AffinePatch2} applied to $p \in \{p_1, \dots, p_v\}$, such that $(\mathfrak{b}, \mathfrak{p}_i) \in M_p$ for some ideal $\mathfrak{b}$;
\item for $i \in \{\nu+1, \dots, v\}$, the corresponding rational prime $p_i \in S$ yields $M_{p_i} = \emptyset$, in which case we set $u_i = 0$;
\item $\mathfrak{a}$ is an ideal of $\mathcal{O}_K$ of norm $|c|\cdot p_1^{t_1} \cdots p_v^{t_v}$ such that
$u_i + t_i =  z_i$. 
\end{itemize}

For each choice of $\mathfrak{a}$ and prime ideals $\mathfrak{p}_1, \dots, \mathfrak{p}_{\nu}$, we reduce equation~\eqref{eq:TMfactored} to a number of so-called ``$S$-unit equations''. We present two different algorithms for doing so and outline the advantages and disadvantages of each. In practicality, we do not know a priori which of these two options is more efficient. Instead, we implement and use both algorithms simultaneously and selecting the most computationally efficient option as it appear. 

%--------------------------------------------------------------------------------------------------------------------------------------------%

\subsection{Avoiding the class group $\Cl(K)$}
\label{subsec:FactorizationTMwithoutOK}

For $i = 1, \dots, {\nu}$ let $h_i$ be the smallest positive integer for which $\mathfrak{p}_i^{h_i}$ is principal and let 
$r_i$ be a positive integer satisfying $0 \leq r_i < h_i$. Let
\[\mathbf{a}_i = (a_{1i}, \dots, a_{{\nu}i}).\]
where $a_{ii} = h_i$ and $a_{ji} = 0$ for $j \neq i$. We let $A$ be the matrix with columns $\mathbf{a}_1, \dots, \mathbf{a}_{\nu}$. Hence $A$ is a $\nu \times \nu$ diagonal matrix over $\mathbb{Z}$ with diagonal entries $h_i$. Now, if \eqref{eq:TMfactored} has a solution $\mathbf{u} = (u_1, \dots, u_{\nu})$, it necessarily must be of the form $\mathbf{u} = A\mathbf{n} + \mathbf{r}$, where $\mathbf{n} = (n_1, \dots, n_{\nu})$ and $\mathbf{r} = (r_1, \dots, r_{\nu})$. The vector $\mathbf{n}$ is comprised of integers $n_i$ which we solve for. The vector $\mathbf{r}$ is comprised of the values $r_i$ satisfying $0 \leq r_i < h_i$ for $i = 1, \dots, \nu$. 

Using the above notation, we let
\[\mathfrak{c}_i = \tilde{\mathfrak{p}}^{\mathbf{a}_i}=\mathfrak{p}_1^{a_{1i}}\cdot \mathfrak{p}_2^{a_{2i}} \cdots \mathfrak{p}_{\nu}^{a_{{\nu}i}} = \mathfrak{p}_i^{h_i} \]
for all $i \in \{1, \dots, {\nu}\}$.

Thus, we can write \eqref{eq:TMfactored} as
\[ (x-y\theta) \mathcal{O}_K = \mathfrak{a} \tilde{\mathfrak{p}}^{\mathbf{u}}  = (\mathfrak{a} \cdot \tilde{\mathfrak{p}}^\mathbf{r}) \cdot \mathfrak{c}_1^{n_1}\cdots \mathfrak{c}_{\nu}^{n_{\nu}}.\]


By definition of $h_i$, each $i \in \{1, \dots, {\nu}\}$ yields an element $\gamma_i \in K^*$ such that 
\[\mathfrak{c}_i = (\gamma_i) \mathcal{O}_K.\]
Furthermore, if $\mathbf{u}$ is a solution of \eqref{eq:TMfactored} with corresponding vectors $\mathbf{n}, \mathbf{r}$, there exists some $\alpha \in K^*$ such that 
\[\mathfrak{a} \cdot \tilde{\mathfrak{p}}^\mathbf{r}= (\alpha)\mathcal{O}_K.\]

%--------------------------------------------------------------------------------------------------------------------------------------------%

\subsection{Using the class group $\Cl(K)$}
\label{subsec:FactorizationTMwithOK}

Let $\mathbf{u}=(u_1,\dots, u_{\nu})$ be a solution of \eqref{eq:TMfactored} and consider the map
\[\phi : \mathbb{Z}^{\nu} \rightarrow \text{Cl}(K), \qquad (x_1,\dots ,x_{\nu}) \mapsto [\mathfrak{p}_1]^{x_1}\cdots [\mathfrak{p}_{\nu}]^{x_{\nu}},\]
where $[ \mathfrak{q} ]$ denotes the equivalence class of the fractional ideal $\mathfrak{q}$. 
Since the product of $\mathfrak{a}$ and $\mathfrak{p}_1^{u_1}\cdots \mathfrak{p}_{\nu}^{u_{\nu}}$ defines a principal ideal, the map $\phi$ implies
\[\phi(\mathbf{u})=[\mathfrak{a}]^{-1}.\]
In particular, if $[\mathfrak{a}]^{-1}$ does not belong to the image of $\phi$ then \eqref{eq:TMfactored} has no solutions. We therefore suppose that $[\mathfrak{a}]^{-1}$ belongs to the image. Let $\mathbf{r}=(r_1,\dotsc,r_{\nu})$ denote a preimage of $[\mathfrak{a}]^{-1}$ and observe that $\mathbf{u} - \mathbf{r}$ belongs to the kernel of $\phi$. The kernel is a subgroup of $\mathbb{Z}^v$ of rank $\nu$. Let $\mathbf{a}_1,\dots,\mathbf{a}_{\nu}$ be a basis for the kernel, where
\[\mathbf{a}_i = (a_{1i}, \dots, a_{\nu i}) \quad \text{ for } i = 1, \dots, \nu.\]
Let
\[\mathbf{u}-\mathbf{r}=n_1 \mathbf{a}_1+\cdots + n_{\nu} \mathbf{a}_{\nu}\]
for some integers $n_i \in \mathbb{Z}$ and let $A$ denote the $\nu \times \nu$ matrix over $\mathbb{Z}$ with columns $\mathbf{a}_1,\dots,\mathbf{a}_{\nu}$. It follows that $\mathbf{u}= A\mathbf{n}+\mathbf{r}$ where $\mathbf{n} = (n_1,\dots,n_{\nu})$.

For $\mathbf{a}_i=(a_{1i},\dotsc,a_{\nu i}) \in \mathbb{Z}^{\nu}$, we adopt the notation 
\[\tilde{\mathfrak{p}}^\mathbf{a} :=\mathfrak{p}_1^{a_{1i}}\cdot \mathfrak{p}_2^{a_{2i}} \cdots \mathfrak{p}_{\nu}^{a_{\nu i}}.\]
Let
\[\mathfrak{c}_1= \tilde{\mathfrak{p}}^{\mathbf{a}_1},\dotsc,\mathfrak{c}_{\nu}= \tilde{\mathfrak{p}}^{\mathbf{a}_{\nu}}.\]
Thus, we can rewrite \eqref{eq:TMfactored} as
\[(x-y\theta) \mathcal{O}_K = \mathfrak{a} \tilde{\mathfrak{p}}^{\mathbf{u}} = (\mathfrak{a} \cdot \tilde{\mathfrak{p}}^\mathbf{r}) \cdot \mathfrak{c}_1^{n_1}\cdots \mathfrak{c}_{\nu}^{n_{\nu}}.\]

Consider the ideal equivalence class of $(\mathfrak{a} \cdot \tilde{\mathfrak{p}}^\mathbf{r})$ in $\Cl(K)$ and note that
\[[\mathfrak{a} \cdot \tilde{\mathfrak{p}}^\mathbf{r}] 
	= [\mathfrak{a}] \cdot [\mathfrak{p}_1]^{r_1}\cdots [\mathfrak{p}_{\nu}]^{r_{\nu}} 
	= [\mathfrak{a}]\cdot \phi(r_1,\dotsc,r_{\nu})=[1]\]
as $\phi(r_1,\dotsc,r_{\nu})=[\mathfrak{a}]^{-1}$ by construction. This means 
\[\mathfrak{a} \cdot \tilde{\mathfrak{p}}^\mathbf{r}= (\alpha) \mathcal{O}_K\]
for some $\alpha \in K^*$. Furthermore, 
\[[\mathfrak{c}_i] = [\tilde{\mathfrak{p}}^{\mathbf{a}_i}] = \phi(\mathbf{a}_i) = [1] \quad \text{ for } i = 1, \dots, \nu,\]
as the $\mathbf{a}_i$ are a basis for the kernel of $\phi$. For all $i \in \{1, \dots, {\nu}\}$, we therefore have
\[\mathfrak{c}_i= (\gamma_i) \mathcal{O}_K\]
for some $\gamma_i \in K^*$.

%--------------------------------------------------------------------------------------------------------------------------------------------%

\subsection{The $S$-unit equation}
\label{subsec:SUnitEquation}

\autoref{subsec:FactorizationTMwithoutOK} and  \autoref{subsec:FactorizationTMwithOK} outline two different algorithms to reduce the ideal equation~\eqref{eq:TMfactored} to a number of certain ``$S$-unit equations'', which we define shortly. Regardless of which method we use, under both algorithms outlined above, equation~\eqref{eq:TMfactored} becomes
\begin{equation} \label{eq:TMprincipal}
(x-y\theta) \mathcal{O}_K= (\alpha \cdot \gamma_1^{n_1} \cdots \gamma_{\nu}^{n_{\nu}}) \mathcal{O}_K
\end{equation}
for some vector $\mathbf{n} = (n_1, \dots, n_{\nu}) \in \mathbb{Z}^{\nu}$. The ideal generated by $\alpha$ in $K$ has norm 
\[|c|\cdot p_1^{t_1 + r_1} \cdots p_{\nu}^{t_{\nu} + r_{\nu}}p_{\nu +1}^{t_{\nu +1}} \cdots p_v^{t_v}\]
and the $n_i$ are related to the $z_i$ via
\[z_i = u_i + t_i = \sum_{j = 1}^{\nu}n_ja_{ij} + r_i + t_i \quad \text{ for } i =1, \dots, v.\]
where $u_i = r_i = 0$ for all $i \in \{\nu + 1, \dots, v\}$. 

Fix a complete set of fundamental units $\{\eps_1, \dots, \eps_r\}$ of $\mathcal{O}_K$. Here $r = s + t -1$, where $s$ denotes the number of real embeddings of $K$ into $\mathbb{C}$ and $t$ denotes the number of complex conjugate pairs of non-real embeddings of $K$ into $\mathbb{C}$. Then, under either method, equation~\eqref{eq:TMfactored} reduces to a finite number of equations in $K$ of the form
\begin{equation} \label{eq:TMinK}
x-y\theta = \alpha \zeta \varepsilon_1^{a_1} \cdots \varepsilon_r^{a_r}\gamma_1^{n_1}\cdots \gamma_{\nu}^{n_{\nu}}
\end{equation}
with unknowns $a_i \in \mathbb{Z}$, $n_i \in \mathbb{Z}$, and $\zeta$ in the set $T$ of roots of unity in $\mathcal{O}_K$. Since $T$ is finite, we treat $\zeta$ as another parameter. 

Let $p \in \{p_1, \dots, p_v, \infty\}$. Recall that $g(t)$ is an irreducible polynomial in $\mathbb{Z}[t]$ arising from \eqref{eq:ThueMahler3} such that
\[g(t) = f(t,1) = t^n + C_1 t^{n-1} + \dots + C_{n-1}t + C_n.\]
Denote the roots of $g(t)$ in $\overline{\mathbb{Q}_p}$ (where $\overline{\mathbb{Q}_{\infty}} = \overline{\mathbb{R}} = \mathbb{C}$) by $\theta^{(1)}, \dots, \theta^{(n)}$. Let $i_0, j, k \in \{1,2,3\}$ be distinct indices and consider the three embeddings of $K$ into $\overline{\mathbb{Q}_p}$ defined by $\theta \mapsto \theta^{(i_0)}, \theta^{(j)}, \theta^{(k)}$. We use $z^{(i)}$ to denote the image of $z$ under the embedding $\theta \mapsto \theta^{(i)}$. From the Siegel identity
\[(\theta^{(i_0)} - \theta^{(j)})(x-y\theta^{(k)}) + (\theta^{(j)} - \theta^{(k)})(x-y\theta^{(i_0)}) + (\theta^{(k)} - \theta^{(i_0)})(x-y\theta^{(j)}) = 0,\]
applying the embeddings to $\beta = x-y\theta$ yields the so-called ``$S$-unit equation''
\begin{equation} \label{eq:Sunit}
\delta_1 \prod_{i = 1}^r\left( \frac{\varepsilon_i^{(k)}}{\varepsilon_i^{(j)}}\right)^{a_i}\prod_{i = 1}^{\nu} \left( \frac{\gamma_i^{(k)}}{\gamma_i^{(j)}}\right)^{n_i} - 1 = \delta_2 \prod_{i = 1}^{r}\left( \frac{\varepsilon_i^{(i_0)}}{\varepsilon_i^{(j)}}\right)^{a_i} \prod_{i = 1}^{\nu} \left( \frac{\gamma_i^{(i_0)}}{\gamma_i^{(j)}}\right)^{n_i},
\end{equation}
where
\[\delta_1 = \frac{\theta^{(i_0)} - \theta^{(j)}}{\theta^{(i_0)} - \theta^{(k)}}\cdot\frac{\alpha^{(k)}\zeta^{(k)}}{\alpha^{(j)}\zeta^{(j)}}, \quad \delta_2 = \frac{\theta^{(j)} - \theta^{(k)}}{\theta^{(k)} - \theta^{(i_0)}}\cdot \frac{\alpha^{(i_0)}\zeta^{(i_0)}}{\alpha^{(j)}\zeta^{(j)}}\]
are constants. 

To summarize, our original problem of solving \eqref{eq:ThueMahler3} for $(x,y,z_1,\dots, z_v)$ has been reduced to solving finitely many equations of the form \eqref{eq:Sunit} for the variables $(x,y, n_1, \dots, n_{\nu},a_1,\dots,a_r)$.

%--------------------------------------------------------------------------------------------------------------------------------------------%

\subsection{Computational remarks and comparisons}
\label{subsec:FactorizationRemarks}

In \autoref{subsec:FactorizationTMwithoutOK}, we follow closely the method of \edit{Tzanakis, de Weger} to reduce the ideal equation~\eqref{eq:TMfactored} to the $S$-unit equation~\eqref{eq:Sunit}. To implement this reduction, we begin by computing all $h_i$ for which $\mathfrak{p}_i^{h_i}$ is principal for $i = 1, \dots, \nu$. In doing so, we generate all possible values for $r_i$, the non-negative integer satisfying $0 \leq r_i < h_i$. We then generate every possible vector $\mathbf{r} = (r_1, \dots, r_{\nu})$ and test the corresponding ideal product $\mathfrak{a} \cdot \tilde{\mathfrak{p}}^{\mathbf{r}}$ for principality. Those vectors which pass this test yield an $S$-unit equation~\eqref{eq:Sunit}. In the worst case scenario, this method reduces to $h_K^{\nu}$ such equations, where $h_K$ is the class number of $K$. Moreover, this process needs to be applied to every ideal equation~\eqref{eq:TMfactored}, yielding what may be a very large number of principalization tests and subsequent large number of $S$-unit equations to solve. \edit{table with numbers}

In contrast, the method in \autoref{subsec:FactorizationTMwithOK} reduces \eqref{eq:TMfactored} to only $\#T/2$ $S$-unit equations to solve, where $T$ is the set of roots of unity in $K$. In particular, the sum total of $S$-unit equations does not drastically increase. If $[\mathbf{a}]^{-1}$ is not in the image of $\phi$, we reach a contradiction. If $[\mathbf{a}]^{-1}$ is in the image of $\phi$ then we obtain only $\#T/2$ corresponding equations \eqref{eq:Sunit}. In particular, the number of principalization tests in this method is limited by the number of ideal equations~\eqref{eq:TMfactored}, where each such equation yields only $(1+\nu)$ tests. \edit{table with numbers}

However, when generating the vectors $\mathbf{r} = (r_1, \dots, r_{\nu})$ using the class group, we observe that some of the integers $r_i$ may be negative, so we do not expect $\alpha$ to be an algebraic integer in general. This can be problematic later in the algorithm when we compute the embedding of $\alpha$ into our $p$-adic fields. In those instances, the precision on our $\theta^{(i)}$ may not be high enough, and as a result, $\alpha$ may be mapped to $0$. Increasing the precision at that point would be computationally inefficient, as it would require us to recompute a large amount of data. Instead, we force the $r_i$ to be positive by adding sufficiently many multiples of the class number. This in itself may present its own problems \edit{can't remember why though}.

In most cases, the method described in \autoref{subsec:FactorizationTMwithOK} is far more efficient than that of \autoref{subsec:FactorizationTMwithoutOK}. However, computing the class group may be a very costly computation. Indeed, for some Thue-Mahler equations, this may be the bottle-neck of the algorithm. In this case, it may happen that computing the class group will take longer than directly checking each potential $S$-unit equation arising from the alternative method. \edit{table}. Unfortunately, we cannot know a piori how long computing $\Cl(K)$ will take in so much that we cannot know a priori how long solving all $S$-unit equations from the other algorithm will take. In practicality, generating the class group in Magma \edit{formatting of Magma?} is a process which cannot be terminated without exiting the program. For this reason, we cannot simply apply a timeout in Magma if computing $\Cl(K)$ is exceeding what we deem a reasonable amount of time. Adding to this, Magma does not support parallelization, so we cannot implement both algorithms simultaneously. Our compromise to solve a single Thue-Mahler equation is to run two separate instances of Magma in parallel, each generating the $S$-unit equations using the two aforementioned algorithms. When one of these instances finishes, the other is forced to terminate. In this way, though far from ideal, we are able to select the most computationally efficient option. 

%--------------------------------------------------------------------------------------------------------------------------------------------%
%--------------------------------------------------------------------------------------------------------------------------------------------%

\section{Lattice-Based Reduction}
\label{sec:LatticeReduction}

\edit{references for this are the two books living in the $x+y=z$ folder on the desktop}

At this point in solving the Thue-Mahler equation, we proceed to solve each $S$-unit equation~\eqref{eq:Sunit} for the exponents $(n_1, \dots, n_{\nu}, a_1, \dots, a_r)$. To do so, we generate a very large upper bound on the exponents and reduce this bound via Diophantine approximation computations. The specific details of this process are described in \autoref{ch:EfficientTMSolver} and \autoref{ch:Goormaghtigh}. In general, from each $S$-unit equation, we generate several linear forms in logarithms to which we associate an integral lattice $\Gamma$. It will be important in this reduction process to enumerate all short vectors in these lattices. In this section, we describe two algorithms used in the short vector enumeration process. These are algorithms which have many important applications in a variety of mathematical fields, including factorization of polynomials, public-key cryptography, and the disproof of the Mertens Conjecture \edit{references from de Weger}. 

%--------------------------------------------------------------------------------------------------------------------------------------------%

\subsection{The $L^3$-lattice basis reduction algorithm}
\label{subsec:LLL}

Let $\Gamma$ be an $n$-dimensional lattice with basis vectors $\mathbf{b}_1, \dots, \mathbf{b}_n$ equipped with a bilinear form $\Phi: \Gamma \times \Gamma \to \mathbb{Z}$. Recall that $\Phi$ defines a norm on $\Gamma$ via the usual inner product on $\mathbb{R}^n$. For $i = 1, \dots, n$, define the vectors $\mathbf{b}_i^*$ inductively by
\[\mathbf{b}_i^* = \mathbf{b}_i - \sum_{j=1}^{i-1}\mu_{ij}\mathbf{b}_j^*, \quad \mu_{ij} = \frac{\Phi(\mathbf{b}_i,\mathbf{b}_j^*)}{\Phi(\mathbf{b}_j^*,\mathbf{b}_j)},\]
where $\mu_{ij} \in \mathbb{R}$ for $1\leq j < i \leq n$. This is the usual Gram-Schmidt process. The basis $\mathbf{b}_1,\dots, \mathbf{b}_n$ is called \textit{LLL-reduced} if
\[|\mu_{ij}| \leq \frac{1}{2} \quad \text{ for } 1\leq j < i \leq n, \]
\[\frac{3}{4}|\mathbf{b}_{i-1}^*|^2 \leq |\mathbf{b}_i^* + \mu_{ii-1}\mathbf{b}_{i-1}^*|^2 \quad \text{ for } 1 <i \leq n,\]
where $| \cdot |$ is the usual Euclidean norm in $\mathbb{R}^n$, 
\[|\mathbf{v}| = \Phi(\mathbf{v},\mathbf{v}) = \mathbf{v}^{T}\mathbf{v}.\]
\edit{is this too much notation? should I stick to jsut using $\Phi$?}

These properties imply that an LLL-reduced basis is approximately orthogonal, and that, generically, its constituent vectors are roughly of the same length. Every $n$-dimensional lattice has an LLL-reduced basis and such a basis can be computed very quickly using the so-called LLL algorithm (\edit{ref: LLL}). This algorithm takes as input an arbitrary basis for a lattice and outputs an LLL-reduced basis. The algorithm is typically modified to additionally output a unimodular matrix $U$ such that $A = BU$, where $B$ is the matrix whose column-vectors are the input basis and $A$ is the matrix whose column-vectors are the LLL-reduced output basis. Several versions of this algorithm are implemented in Magma \edit{typeset for Magma}, including de Weger's exact integer version. (\edit{ref}).

We remark that a lattice may have more than one reduced basis, and that the ordering of the basis vectors is not arbitrary. The properties of reduced bases that are of most interest to us are the following. Let $\mathbf{v}$ a vector in $\mathbb{R}^n$ and denote by $l(\Gamma,\mathbf{v})$ the distance from $\mathbf{v}$ to the nearest point in the lattice $\Gamma$, viz.
\[l(\Gamma,\mathbf{v}) = \min_{\mathbf{u} \in \Gamma \backslash\{\mathbf{v}\}} |\mathbf{u} - \mathbf{v}|.\]
From an LLL-reduced basis for $\Gamma$, we can compute lower bounds for $l(\Gamma,\mathbf{v})$, according to the following results. 

\begin{lemma} \label{lem:LLL}
Let $\Gamma$ be a lattice with LLL-reduced basis $\mathbf{c}_1, \dots, \mathbf{c}_n$ and let $\mathbf{v}$ be a vector in $\mathbb{R}^n$. 
\begin{enumerate}[(a)]
\item If $\mathbf{v} = \mathbf{0}$, then $l(\Gamma,\mathbf{v}) \geq 2^{-(n-1)/2}|\mathbf{c}_1|$.
\item Assume $\mathbf{v} = s_1\mathbf{c}_1 + \cdots + s_n \mathbf{c}_n$, where $s_1, \dots, s_n \in \mathbb{R}$ with not all $s_i \in \mathbb{Z}$. Put 
\[J = \{j \in \{1, \dots, n\} \ : \ s_j \notin \mathbb{Z} \}.\]
For $j \in J$, set 
\[\delta(j) = 
\begin{cases}
\max_{i > j} \|s_i \| |\mathbf{c}_i| 	& \text{ if } j < n\\
0 							& \text{ if } j = n,
\end{cases}\]
where $\| \cdot \|$ denotes the distance to the nearest integer. We have
\[l(\Gamma,\mathbf{v}) \geq \max_{j \in J}\left(2^{-(n-1)/2}\| s_j\| |\mathbf{c}_1| - (n-j)\delta(j)\right).\]
\end{enumerate}
\end{lemma}
\edit{refs of where this lemma can be found - Cohen, for 1; see Hambrook p49 bottom of Lemma 18.1}
Note that the assumption in Lemma~\ref{lem:LLL} is equivalent to ${\mathbf{v} \notin \Gamma}$. 

We see that the vector $\mathbf{c}_1$ in a reduced basis is, in a very precise sense, not too far from being the shortest non-zero vector of $\Gamma$. As has already been mentioned, what makes this result so valuable is that there is a very simple and efficient algorithm to find a reduced basis in a lattice, namely the LLL algorithm.

%--------------------------------------------------------------------------------------------------------------------------------------------%

\subsection{The Fincke-Pohst algorithm}
\label{subsec:FinckePohst}

Sometimes it is not sufficient to have a lower bound for $l(\Gamma,\mathbf{v})$ only. It may be useful to know exactly all vectors $\mathbf{u} \in \Gamma$ such that $|\mathbf{u}|  = \Phi(\mathbf{u}, \mathbf{u}) \leq C$ for a given constant $C$. This can be done efficiently using an algorithm of Fincke-Pohst (\edit{ref: p49 of Hambrook}). A version of this algorithm with some improvements due to Stehl\'e is implemented in Magma \edit{format}. As input this algorithm takes a matrix $B$, whose columns span the lattice $\Gamma$, and a constant $C > 0$. The output is a list of all lattice points $\mathbf{u} \in \Gamma$ with $|\mathbf{u}| \leq C$, apart from $\mathbf{u} = \mathbf{0}$. In this section, we outline the main steps in this algorithm. 

We begin by letting $B$ denote the basis matrix associated to the lattice $\Gamma$, with corresponding bilinear form $\Phi$. We call a vector $\mathbf{u} \in \Gamma$ \textit{small} if its norm $\Phi(\mathbf{u}, \mathbf{u})$ is less than a constant $C$. As an element of the lattice, $\mathbf{u} = B\mathbf{x}$ for some coordinate vector $\mathbf{x} \in \mathbb{Z}^n$. Let $Q$ be the quadratic form associated to $\Phi$ and let $A=B^TB$. Now finding the short vectors $\mathbf{u} \in \Gamma$ is equivalent to solving 
\begin{equation} \label{eq:ShortVector}
Q(\mathbf{x}) = \mathbf{x}^TA\mathbf{x} \leq C.
\end{equation}

Let $\mathbf{x} = (x_1, \dots, x_n)$. To solve this inequality, we first rearrange the terms of the quadratic form via quadratic completion. Here we assume that $\Gamma$ is positive definite so that every nonzero element of the lattice has a positive norm. With this, we find the Cholesky decomposition $A = R^TR$, where $R$ is an upper triangular matrix, and express $Q$ as
\[ Q(\mathbf{x}) = \sum_{i=1}^n q_{ii}\left( x_i + \sum_{j=i+1}^n q_{ij}x_j\right)^2.\]
The coefficients $q_{ij}$ are defined from $R$ and stored in a matrix $\tilde{Q}$ for convenience. In particular, 
\begin{equation} \label{eq:CholeskyCoeffs}
q_{ij} =
\begin{cases}
\frac{r_{ij}}{r_{ii}} & \text{ if } i < j\\
r_{ii}^2 & \text{ if } i = j.
\end{cases}
\end{equation}
Since $R$ is upper triangular, the matrix $\tilde{Q}$ is as well. This yields the following reformulation of \eqref{eq:ShortVector}
\[ \sum_{i=1}^n q_{ii}\left( x_i + \sum_{j=i+1}^n q_{ij}x_j\right)^2 \leq C.\]
From here we observe that the individual term $q_{nn}x_n^2$ must also be less than $C$. Specifically, 
\[x_n^2 \leq \frac{C}{q_{nn}}\]
so that $x_n$ is bounded above by $\sqrt{C/q_{nn}}$ and below by $-\sqrt{C/q_{nn}}$. This illustrates the first step in establishing bounds on a specific entry $x_i$. Adding more terms from the outer sum to this sequence, a pattern emerges. Let
\[U_k = \sum_{j = k+1}^n q_{kj}x_j,\]
where $U_n = 0$, and rewrite $Q(\mathbf{x})$ as 
\[Q(\mathbf{x}) = \sum_{i=1}^n q_{ii}\left( x_i + \sum_{j=i+1}^n q_{ij}x_j\right)^2 = \sum_{i=1}^n q_{ii}\left( x_i + U_i\right)^2.\]
In general, 
\[q_{kk}(x_k + U_k)^2 \leq C - \sum_{i = k+1}^n q_{ii}(x_i + U_i)^2.\]
Let $T_k$ denote the bound on the right-hand side, 
\[T_k = C - \sum_{i = k+1}^n q_{ii}(x_i + U_i)^2.\]
We set $T_n = C$ and find each subsequent $T_k$ by subtracting the next term from the outer summand,
\[T_k = T_{k+1} - q_{k+1,k+1}(x_{k+1} + U_{k+1})^2.\]
This yields the upper bound
\[q_{kk}(x_k + U_k)^2 \leq T_k\]
so that $x_k$ is bounded above by $\sqrt{T_k/q_{kk}} - U_k$ and below by ${-\sqrt{T_k/q_{kk}} - U_k}$. In this way, we iteratively enumerate all vectors $\mathbf{x}$ satisfying $Q(\mathbf{x}) \leq C$, beginning with the entry $x_n$ of $\mathbf{x}$ and working down towards $x_1$.  

%--------------------------------------------------------------------------------------------------------------------------------------------%

\subsection{Computational remarks and translated lattices}
\label{subsec:FinckePohstRemarks}

Recall that the Cholesky decomposition of $A = B^TB$ yields the upper triangular matrix $R$ where $A = R^TR$. It is noted in the \edit{Fincke-Pohst paper} that if we label the columns of $R$ by $\mathbf{r}_i$ and the rows of $R^{-1}$ by $\mathbf{r}'_i$, then 
\[x_k^2 = \left( \mathbf{r}'^{\ T}_k \cdot \sum_{i=1}^n x_i \mathbf{r}_i \right)^2 \leq \mathbf{r}'^{\ T}_k \mathbf{r}_k (\mathbf{x}^TR^TR\mathbf{x}) \leq | \mathbf{r}'_k |^2C.\]
To reduce the search space, it is thus beneficial to reduce the rows of $R^{-1}$. Furthermore, rearranging the columns of $R$ so that the shortest column vector is first helps reduce the total running time of the Fincke-Pohst algorithm. In particular, doing so leads to progressively smaller intervals in which $x_k$ may exist. 

We express this reduction with a unimodular matrix $V^{-1}$ so that $R_1^{-1} = V^{-1}R^{-1}$. Applying an appropriate permutation matrix $P$, we then reorder the columns of $R_1$. Since $R_1 = RV$, this yields $R_2 = (RV)P$. Finally, we compute the solutions $\mathbf{y}$ to $\mathbf{y}^TR_2^TR_2\mathbf{y}\leq C$ and recover the short vectors $\mathbf{x}$ satisfying the original inequality \eqref{eq:ShortVector} via $\mathbf{x} = VP\mathbf{y}$. 

As before, let $\Gamma$ be an $n$-dimensional lattice with basis matrix $B$, quadratic form $\Phi$, and associated bilinear form $Q$. In \autoref{subsec:FinckePohst}, it is noted that an implementation of the Fincke-Pohst algorithm is available in Magma (\edit{text}). Unfortunately, this implementation does not support \textit{translated} lattices, a variant of the Fincke-Pohst algorithm which we will need in \autoref{ch:EfficientTMSolver}. By a translated lattice, we mean the discrete subgroup of $\mathbb{R}^n$ of the form
\[\Gamma + \mathbf{w} = \left\{ \sum_{i=1}^n x_i \mathbf{b}_i + \mathbf{w}\ : \ x_i \in \mathbb{Z} \right\},\]
where $\mathbf{b}_1, \dots, \mathbf{b}_n$ form the columns of $B$ and $\mathbf{w} \in \mathbb{R}^n$. In the remainder of this section, we describe how to modify the Fincke-Pohst algorithm and its refinements to support translated lattices. 

Analogous to the non-translated case, any embedded vector $\mathbf{u}$ of $\Gamma + \mathbf{w}$ may be expressed as $\mathbf{u} = B\mathbf{x} + \mathbf{w}$ for a corresponding coordinate vector $\mathbf{x}$. In this case, we call the vector $\mathbf{u} \in \Gamma + \mathbf{w}$ \textit{small} if 
\begin{equation} \label{eq:TransShortVector}
(\mathbf{x}-\mathbf{c})^TB^TB(\mathbf{x}-\mathbf{c}) \leq C
\end{equation}
for some $C \geq 0$, where $\mathbf{c} = -\mathbf{w}$. 

As in the usual short vectors process, we begin by applying Cholesky decomposition to the positive definite matrix $A=B^TB$ to obtain an upper triangular matrix $R$ satisfying $A = R^TR$. We then generate the matrices $R_1, R_2, V,$ and $P$ described earlier in this section. This allows us to write $A = U^TGU$ for a unimodular matrix $U$ and Gram matrix $G$ given by
\[U = P^{-1}V^{-1} \quad \text{ and } \quad G = R_2^TR_2.\]
Thus the inequality~\eqref{eq:TransShortVector} becomes
\begin{equation} \label{eq:TransShortVector2}
(\mathbf{y}-\mathbf{d})^TG(\mathbf{y}-\mathbf{d}) \leq C
\end{equation}
where
\[\mathbf{y} = U\mathbf{x} \quad \text{ and } \quad \mathbf{d} = U\mathbf{c}.\]
To enumerate the vectors $\mathbf{y}$ which satisfy this inequality, we consider the bilinear form $Q$ associated to the lattice $\Gamma$. We express this form as
\[ Q(\mathbf{y}-\mathbf{d}) = \sum_{i=1}^n q_{ii}\left( y_i - d_i + \sum_{j=i+1}^n q_{ij}(y_j - d_j)\right)^2.\]
As in the usual Fincke-Pohst algorithm, the coefficients $q_{ij}$ are defined from the matrix $R$ via equation~\eqref{eq:CholeskyCoeffs}. Let
\[U_k = -d_k + \sum_{j = k+1}^n q_{kj}(y_j - d_j),\]
where $U_n = -d_n$, and rewrite $Q(\mathbf{y}-\mathbf{d})$ as
\[ Q(\mathbf{y}-\mathbf{d}) = \sum_{i=1}^n q_{ii}\left( y_i - d_i + \sum_{j=i+1}^n q_{ij}(y_j - d_j)\right)^2 = \sum_{i=1}^n q_{ii}\left( y_i + U_i\right)^2.\]
From here, we proceed as in the usual Fincke-Pohst algorithm described in \autoref{subsec:FinckePohst}. Once we compute all vectors $\mathbf{y}$ which satisfy \eqref{eq:TransShortVector2}, we recover $\mathbf{x}$ using $\mathbf{x} = U^{-1}\mathbf{y}$. 

As a final remark about Fincke-Pohst for translated lattices, it is worth noting that one could use the variant implemented in Magma (\edit{format}) simply by increasing the dimension of the lattice $\Gamma$ and appropriately redefining the basis vectors $\mathbf{b}_i$. This is highly ill-advised as it increases the search space and subsequent running time of the algorithm.  

Generally speaking, the use of Fincke-Pohst in our applications poses one of the main bottlenecks in solving Thue-Mahler and Thue-Mahler-like equations. Specifically, this algorithm often yields upwards of hundreds of millions of short vectors, each one needing to be stored and, in our case, appropriately manipulated. This creates both timing and memory problems, often leading to gigabytes of data usage. Deleting these vectors does not release the memory and, as with the class group function, Magma's (\edit{format}) built-in Fincke-Pohst process cannot be terminated without exiting the program. The primary advantage of implementing and using our own version of Fincke-Pohst, as described in this section, is therefore the ability to add a fail-stop should the number of vectors found become too large.   \edit{table of large numbers of short vectors found?}

%--------------------------------------------------------------------------------------------------------------------------------------------%
%--------------------------------------------------------------------------------------------------------------------------------------------%

\endinput

Any text after an \endinput is ignored.
You could put scraps here or things in progress.


